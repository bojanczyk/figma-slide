<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;500&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/thomas-lowry/figma-plugin-ds@master/dist/figma-plugin-ds.css">
<style>


:root {
  --grafitowy : #2c2c2c;
	--niebieski : #18A0FB;
  --select-color : #daebf7;
  --disabled-color : Silver;
}


body {
    font-family: 'Inter';
    font-size: 11px;
    letter-spacing : 0.2;
    font-weight : 400;
    letter-spacing : 0.055px;
}

input {
	font-family: 'Inter';
    font-size: 11px;
    letter-spacing : 0.2;
    font-weight : 400;
    letter-spacing : 0.055px;
}


.material-icons {
  font-size : 16px;
}

.list-buttons {
  float : right;
  display : inline-block;
}

.list-buttons .material-icons {
  opacity : 0
}

.list-item:hover div .material-icons {
  opacity : 1;
  color : black;
  cursor  : pointer;
}

.list-item i {
padding-right : 8px;
}

.list-label{
  margin-left : 0px;
  display : inline-block;
  color : var(--grafitowy);
  text-overflow: ellipsis;
  max-width: 150px;
  white-space : nowrap;
  overflow : hidden;
  flex : 1;
}


.list-item {
  padding-top : 6px;
  padding-bottom: 6px;
  display : flex;
  align-items : center;
}

#event-list .list-item {
   padding-left : 10px;
}

.dropdown-content > .list-item {
  padding-left : 0px;
}


.disabled .list-label {
color : LightGrey;
}

#current-slide {
  display : inline-block;
}


.column {
  display : flex;
  vertical-align : text-top;
  width : 100%;
  height: 100%
}

.row {
  padding : 10px;
}

.separator {
  border-style : solid;
  border-width : 1px;
  border-color :Grey;
  margin-top : 5px;
  margin-bottom : 5px;
}


/* buttons on the top panel *********** */

.top-buttons {
  display : flex;
  background-color: black;
  align-items : center;
  padding-right : 5px;
}

.top-buttons div div {
  filter : invert(100%);
}

.top-buttons i {
  color : white;
  cursor : pointer;
}

.top-buttons i:hover {
  /*background-color : var(--select-color);
  color : var(--grafitowy);*/
}

.hidden {
  display : none;
}

.row .button {
  margin-left : 10px;
  margin-bottom : 10px;
}

#slide-name {
  color :white;
  flex : 1;
  margin-left : 2px;
}

#slide-count {
  color : white;
  margin-right : 10px;
  margin-left: 10px;
}

#parent-button {
  color : white;
  cursor:pointer;
}

#icon-play {
cursor:pointer;
}

#event-list {
	margin-top : 8px;
  flex : 1;
  overflow : scroll;
}


/* matematyk -------------------- */

#matematyk {
  background-color: LightGrey;
  padding-top : 5px;
  padding-bottom : 5px;
}

.matematyk-row {
  padding-left : 4px;
  padding-right : 4px;
  padding-right : 4px;
  display : flex;
  align-items : center;
  color : var(--grafitowy);
  cursor : pointer;
  height : 32px;
}

.matematyk-row.disabled {
  cursor : default;
}

.matematyk-row:hover:not(.disabled) {
background-color : var(--select-color);
}

#matematyk-words {
  margin-left : 8px;
  display : flex;
  align-items : top;
  overflow : scroll;
  height : 30px;
}

.spacer {
  flex : 1;
}

.sigma-button {
  margin-left : 5px;
  margin-right : 10px;
}

#matematyk input {
  margin : 5px;
  width : 25px;
  font-face : STIXGeneral;
}

.word-button {
  padding : 5px;
  margin-top : 2px;
  margin-bottom : 2px;
  cursor : default;
}

#matematyk-words:not(.disabled) .word-button:hover {
  background-color : var(--select-color);
  cursor : pointer;
}

.disabled {
  color : var(--disabled-color)
}

.disabled input {
  color : LightGrey;
}



.myspinner {
		-webkit-animation: rotation 2s infinite linear;
}

@-webkit-keyframes rotation {
		from {
				-webkit-transform: rotate(0deg);
		}
		to {
				-webkit-transform: rotate(359deg);
		}
}

/* settings column ************ */

#close-settings {
  position: absolute;
  right : 5px;
  top : 5px;
  cursor : pointer;
}

/* no-slide column ****** */

#no-slide-column i {
  position: absolute;
  right : 5px;
  top : 5px;
  cursor : pointer;
}


/* toolbar for events */
#event-toolbar {
	display : flex;
	height : 35px;
  background-color: var(--grafitowy);
	align-items: center;
	padding-left: 8px;
}

#event-toolbar .disabled {
	color: darkgray;
}

.event-toolbar-element {
	user-select: none;
  color : white;
  cursor: pointer;
	height: 100%;
	display : flex;
	align-items: center;
	padding : 5px;
	padding-right : 8px;
}

.dropping-arrow {
	margin-left: 4px;
}

.dropping-arrow:hover  {
  margin-top: 10px;
}

#event-toolbar .labelrow {
	padding : 10px;
}

#event-toolbar .row {
	display : flex;
}

.event-toolbar-element:hover:not(.disabled) {
	background-color: Black;
}
.row i {
	padding-right: 7px;
}

.row .label {
	padding-left : 7px;
}

.toolbar-dropdown .row:hover:not(.disabled) {
	background-color:var(--niebieski) ;
}

.toolbar-triangle {
	opacity: 0;
	position: relative;
	top : 20px;
	left : -13px;
	width: 0; 
  height: 0; 
  border-left: 6px solid transparent;
  border-right: 6px solid transparent;
  
  border-bottom: 6px solid var(--grafitowy);
}

.unfolded .toolbar-triangle {
	display: block;
	opacity : 100%
}

.toolbar-dropdown {
	display : none;
	border-radius: 2px;
  position: absolute;
  background-color: var(--grafitowy);
  min-width: 210px;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
  z-index: 1;
	left : 10px;
  top : 72px;
  overflow : scroll;
	max-height: 400px;
}

.unfolded .toolbar-dropdown {
	display : inline-block;
}

</style>
<div id="entire-plugin" onmouseenter="pluginMouseenter();" onmouseleave="pluginMouseleave()">
	<div class="column hidden" id="settings-column">
		<i id="close-settings" class="material-icons" onclick="settingsPanel(false)">close</i>
		<div class="row">
			Settings
		</div>

		<div class="row">
			<div class="switch" id="matematyk-toggle">
				<input class="switch__toggle" type="checkbox" id="matematyk-checkbox">
				<label class="switch__label" for="uniqueIdA">Latex and math extension</label>
			</div>
		</div>
	</div>


	<div class="column hidden" id="no-slide-column">
		<i class="material-icons" onclick="settingsPanel(true)">settings</i>
		<div class="row">
			No slide is selected.
		</div>
		<div class="row">
			<button class='button button--primary' onclick='makeFirst(1024,768)'>Create slide 1024 x 768</button>
			<button class='button button--primary' onclick='makeFirst(1280,960)'>Create slide 1280 x 960</button>
		</div>
	</div>

	<div class="column hidden" id="slide-column">
		<div class="top-buttons">
			<div class="icon-button" onclick="exportButton()">
				<div id="icon-play" class="icon icon--play"></div>
			</div>
			<div id="slide-name">
				mikla </div>
			<i id="parent-button" class="material-icons" onclick="parentButton()">arrow_upward</i>
			<div id="slide-count"></div>
			<i class="material-icons" onclick="settingsPanel(true)">settings</i>
		</div>

		<!-- The toolbar which contains buttons for creating events -->
		<div id="event-toolbar">
			<!-- the dropdown menu for showing/hiding -->
			<div class="event-toolbar-element" id="event-toolbar-show">
				<i class="material-icons">visibility</i>
				<div class='dropping-arrow'>
					<i class="material-icons">keyboard_arrow_down</i>
				</div>
				<div class='toolbar-triangle'>
				</div>
				<div class="toolbar-dropdown" id="dropdown-show">
					<div class="row" id='dropdown-show-show'>
						<i class="material-icons">visibility</i>
						Create a showing event
					</div>
					<div class="row" id='dropdown-show-hide'>
						<i class="material-icons">visibility_off</i>
						Create a hiding event
					</div>
				</div>
			</div>
			<!-- the dropdown menu for zoom events -->
			<div class="event-toolbar-element" id="event-toolbar-zoom">
				<i class="material-icons">zoom_out_map</i>
				<div class='dropping-arrow'>
					<i class="material-icons">keyboard_arrow_down</i>
				</div>
				<div class='toolbar-triangle'>
				</div>
				<div class="toolbar-dropdown" id="dropdown-zoom">
					<div class="labelrow">
						Create a link to new slide
					</div>
					<div class="row" id='dropdown-zoom-new'>
						<i class="material-icons">add</i>
						<input type="input" id='new-child-name' placeholder='Name of new slide' />
					</div>
					<div class="separator"> </div>
					<div class="labelrow">
						Create a link to existing slide
					</div>
				</div>
			</div>

		</div>

		<!-- the list of events in the current slide -->
		<div id="event-list"> </div>


		<div id='matematyk'>
			<div class="matematyk-row" id='matematyk-latex'>
				<i id="latexit-icon" class="material-icons sigma-button">
					functions
				</i>
				<div id='latex-button'> Latex selection </div>
				<div class="spacer"> </div>
			</div>
			<div class="matematyk-row" id='matematyk-insert'>
				<i class="material-icons sigma-button">
					functions
				</i>
				<div> Insert </div>
				<input type="input" id='matematyk-input' placeholder="Î£">
				<div> in math font </div>
			</div>
			<div id="matematyk-words">
			</div>
		</div>
	</div>
</div>


<script src="https://cdn.jsdelivr.net/gh/thomas-lowry/figma-plugin-ds/dist/iife/figma-plugin-ds.js"></script>
<script>
    selectMenu.init(); //initiates the select menu component
    disclosure.init(); //initiates the disclosure component
</script>

<script>
// global variables  *******************

//prefix of dropdown id's
//this is meant to avoid coincidences with id's
const dropDownPrefix = "dropdown-prefix:";

//the id of the currently selected slide
var currentSlide;

//name of the figma document
var docName;


// functions **************************


//columns are the alternative views for the plugin ui: 
//slide-column for editing a slide
//no-slide-column which allows making a new slide
//settings-column for the settings

var savedColumn //the previous column before entering settings. 

function showColumn(column) 
{
  if (column != 'settings-column')
    savedColumn = column;
  
  //first hide the other columns
  for (let p of document.getElementsByClassName("column"))
    p.classList.add("hidden");

  document.getElementById(column).classList.remove("hidden");
}

// the settings panel ****************


function settingsPanel(visible) {
  if (visible)
    showColumn('settings-column')
  else
    showColumn(savedColumn)


}

//toggle the play button between "spinner" and "play"
function exportWaiting(waiting) {
  var button = document.getElementById("icon-play");
  if (waiting) {
    button.classList.remove("icon--play");
    button.classList.add("icon--spinner");
    button.classList.add("icon--spin");
  } else {
    button.classList.add("icon--play");
    button.classList.remove("icon--spinner");
    button.classList.remove("icon--spin");
  }
}




//send the presentation to the server
function savePresentation(msg) {
  //for some reason, TextDecoder does not work on the plugin side
  for (const slide of msg.slideList) {
    slide.svg = new TextDecoder("utf-8").decode(slide.svg)
  }

  fetch('http://localhost:8001', {
    method: 'POST',
    body: JSON.stringify({
      type: 'slides',
      presentation: msg.presentation,
      slideList: msg.slideList,
      tree : msg.tree
    })
  }).
  then(x => {
      exportWaiting(false);
      notify("Successfully exported slides to the server.")
    })
    .catch((error) => {
      notify("Not connected to the slide server. Run it locally, it is in the viewer directory.");
      exportWaiting(false);
    });
}

//the user has clicked the button to go to the parent slide
function parentButton() {
postMessage({
    type: 'gotoParent'
  });
}

//the user has clicked the button to export the slides
function exportButton() {
  exportWaiting(true);
  postMessage({
    type: 'saveFile'
  });
}

//make first slide
function makeFirst(width, height) {
  postMessage({
    type: 'makeFirst',
    width: width,
    height: height
  })
}


//display a figma alert. Aparently, only the figma side can do this.
function notify(text) {
  postMessage({
    type: 'notify',
    text: text
  })
}

//for some reason that I do not understand, the mouseleave is not paired with mouse enter, so I do this manually using the following variable
cursorInsidePlugin = false;
//the plugin panel has been moused over
function pluginMouseenter() {
    if (!cursorInsidePlugin) {
      cursorInsidePlugin = true;
    postMessage({
      type: 'mouseEnterPlugin'
    })
    }

  }


function pluginMouseleave() {
  cursorInsidePlugin = false;
  postMessage({
    type: 'hoverEvent',
    index : -1
  })
}

// reordering events in the event list. I use a manual implementation of reordering via dragging, which is probably quite buggy.

let drag_dragged;
let dragSource;
let dragTarget;
let drag_list;


document.addEventListener("dragstart", ({
  target
}) => {
  drag_dragged = target;
  drag_list = target.parentNode.children;
  for (let i = 0; i < drag_list.length; i += 1) {
    if (drag_list[i] === drag_dragged) {
      dragSource = i;
    }
  }
});

document.addEventListener("dragover", (event) => {
  event.preventDefault();
});





document.addEventListener("drop", ({
  target
}) => {
  var realtarget;
  if (target.classList.contains("dropzone"))
    realtarget = target;
  if (target.parentElement.classList.contains("dropzone"))
    realtarget = target.parentElement;

  if (realtarget != null && realtarget !== drag_dragged) {
    for (let i = 0; i < drag_list.length; i += 1) {
      if (drag_list[i] === realtarget) {
        dragTarget = i;
      }
    }
    drag_dragged.remove(drag_dragged);
    if (dragSource > dragTarget) {
      realtarget.before(drag_dragged);
    } else {
      realtarget.after(drag_dragged);
    }
    postMessage({
      type: 'reorderEvents',
      source: dragSource,
      target: dragTarget
    });
  }
});
// ******* end of dragging code






//shortcut for posting a message, so that I don't need to write the '*' each time
function postMessage(msg) {
  parent.postMessage({
    pluginMessage: msg
  }, '*');
}


function changeSlide(msg) {
  docName = msg.docName;
  if ('slide' in msg) {
    //there is a current slide
    showColumn('slide-column');
    document.getElementById('slide-name').innerHTML = msg.slide;

    //display the number of slides (frames) in the presentation
    document.getElementById('slide-count').innerHTML = '' + msg.slideCount;
    //the parent button indicates if there is a parent slide
    if (msg.parent == null)
      document.getElementById('parent-button').classList.add("hidden")
    else
      document.getElementById('parent-button').classList.remove("hidden")

  } else {
    showColumn('no-slide-column');
  }
}

function eventIconClick(index) {
  postMessage({
    type: 'clickEvent',
    index: index
  });
}

function eventRemoveClick(index) {
  postMessage({
    type: 'removeEvent',
    index: index
  });
}

function eventHover(index) {
  postMessage({
    type: 'hoverEvent',
    index: index
  })
}

//get the list of events for the current slide
function eventList(msg) {

  //make a list item for the list of events 
function makeEvent(event, index) {

  let div = document.createElement('div');
  div.innerHTML= '<div class="list-item dropzone" onmouseenter="eventHover('+ index +')" draggable="true"><i onclick="eventIconClick('+ index +')" class="material-icons"></i><div class="list-label"> </div><div class="list-buttons"><i onclick="eventRemoveClick('+ index +')" class="material-icons">delete_outline</i></div></div>'
  const retval = div.firstChild;
  
  if (event.disabled)
    retval.classList.add("disabled");
  if (event.type == "show")
    retval.childNodes[0].innerHTML = "visibility";
  if (event.type == "hide")
    retval.childNodes[0].innerHTML = "visibility_off";
  if (event.type == "child")
    retval.childNodes[0].innerHTML = "zoom_out_map";
  retval.childNodes[1].innerHTML = event.name;
  return retval;
}

  var eventListHTML = document.getElementById("event-list");
  eventListHTML.innerHTML = "";
  for (let i = 0; i<msg.events.length; i++) {
    eventListHTML.appendChild(makeEvent(msg.events[i],i));
  }
}

//if the selection was changed in the ui, we need to disable/enable corresponding elements of the toolbar and dropdown. This function is triggered by a message from figma.
function selChange(msg) {
	const eventDropdowns = [
		'event-toolbar-show', 'dropdown-show-show', 'dropdown-show-hide'
	]

	for (const i of eventDropdowns) {
		var dom = document.getElementById(i);
		if (msg.selected) {
			dom.classList.remove('disabled')
		} else {
			dom.classList.add('disabled')
		}
	}
}

//the event handlers for the clicking on the buttons in the event toolbar, which create dropdowns 
for (const toolbarButton of document.getElementsByClassName('event-toolbar-element')) {
	toolbarButton.addEventListener('click', (event) => {
		//go up the tree until you find a button
		function stoppingCriterion(target) {
			return (target.nodeName == 'DIV');
		}
		var target = event.target;
		while (!stoppingCriterion(target)) {
			target = target.parentNode;
		}
		if (target.classList.contains('dropping-arrow')) {
			//the little drop-down arrow was clicked, which means that the visibility of the dropdown should be toggled

			if (toolbarButton.classList.contains('unfolded'))
				toolbarButton.classList.remove('unfolded')
			else {
				//fold the other toolbars
				for (const otherToolbarButton of document.getElementsByClassName('event-toolbar-element'))
					otherToolbarButton.classList.remove('unfolded');
				//unfold the current one
				toolbarButton.classList.add('unfolded');
				//ask for a refresh of the dropdown contents
				postMessage({
					type: 'requestDropDown'
				});
			}
		} else {
			if (!target.classList.contains('disabled')) {
				//do what needs to be done

				//the button that was clicked is one for the show/hide events
				if (target.id.startsWith('dropdown-show-') || target.id == 'event-toolbar-show') {
					showEventsClicked(target.id);
					toolbarButton.classList.remove('unfolded');
				}

				// a link to a child was created
				if (target.id.startsWith(dropDownPrefix)) {
					var clickedid = target.id.slice(dropDownPrefix.length);
					postMessage({
						type: 'createEvent',
						id: clickedid,
						subtype: 'child'
					});
					toolbarButton.classList.remove('unfolded');
				}

				// creation of a new child is requested
				if (target.id == 'event-toolbar-zoom' || target.id == 'dropdown-zoom-new' ) {
					postMessage({
						type: 'createEvent',
						id: null,
						subtype: 'child'
					});
					toolbarButton.classList.remove('unfolded');
				}

			}

		}
	});
}


// what is done when the toolbar for show/hide events has been clicked. id is the id of the clicked dom element
function showEventsClicked(id) {
	var subtype = 'show';
	if (id.startsWith('dropdown-show-'))
			subtype =  id.slice('dropdown-show-'.length);
	postMessage({
		type: 'createEvent',
		subtype: subtype
	})
}



//get the contents for the dropdown menu 
function dropDownContents(msg) {

		var zoomDropdown = document.getElementById('dropdown-zoom');

		//remove menu items that are child links
		var toDelete = [];
		for (const child of zoomDropdown.childNodes)
			{
				if (child.id != undefined)
				if (child.id.startsWith(dropDownPrefix))
					toDelete.push(child);
			}	
		for (const child of toDelete)
			child.remove();

		
		
		//create new ones, based on the msg 
    for (const item of msg.slides) {
			var child = document.createElement("div");
			child.classList.add('row');
      child.id = dropDownPrefix + item.id;
      child.innerHTML = '<i class="material-icons">zoom_out_map</i>' + item.name;
      zoomDropdown.appendChild(child)

			
    }
}



//functions for the matematyk plugin 
function matematykSendWord(w) {
  postMessage({
          type : 'matematykWord',
          word : w
        })
}



document.getElementById('matematyk-toggle').addEventListener('click',
function (event)   {
  const checkbox = document.getElementById('matematyk-checkbox');
  checkbox.checked = !checkbox.checked;
  if (checkbox.checked)
    {
      document.getElementById('matematyk').style.display = '';
    }
    else 
    {
      document.getElementById('matematyk').style.display = 'none'
    }
  postMessage({
          type : 'matematykToggle',
          active : checkbox.checked
        })
}
)

//the user has clicked the latex / delatx button
document.getElementById('matematyk-latex').addEventListener('click',
  function (event) {
    postMessage({
      type : 'latexit'
    })
  }
)



//the user has filled in the math field, which should insert the contents of the math field into the currently selected text, in the font STIXGeneral
document.getElementById('matematyk-input').addEventListener('keyup',
  function (event) {
    if (event.key == 'Enter') 
    {
      matematykSendWord(event.target.value)
    }
    
  }
)



function fetchLatex(url) {
  document.getElementById("latexit-icon").classList.add("myspinner");
  fetch(url).then(x => {
    if (!x.ok) {
      throw "nic"
    } else return x.text()
  }).then(x => {
    parent.postMessage({
      pluginMessage: {
        type: 'svg',
        svg: x
      }
    }, '*');
    document.getElementById("latexit-icon").classList.remove("myspinner");
  }).catch((error) => 
  {notify("Could not compile latex.");
  document.getElementById("latexit-icon").classList.remove("myspinner");
  })
}


//create the matematyk panel, which allows to make latex and math symbols
function matematyk(msg) {

  

  if (msg.canInsert) {
    document.getElementById('matematyk-insert').classList.remove('disabled');
    document.getElementById('matematyk-words').classList.remove('disabled');
    document.getElementById('matematyk-input').disabled = false;
  }
  else
  {
    document.getElementById('matematyk-words').classList.add('disabled');
    document.getElementById('matematyk-insert').classList.add('disabled');
    document.getElementById('matematyk-input').disabled = true;
  }
    
  if (msg.latexState == null)  //no object is selected, so the latex button should be disabled
  { 
    document.getElementById('matematyk-latex').classList.add('disabled')
  }

  if (msg.latexState == 'latex')  //a text object is selected
  { 
    document.getElementById('matematyk-latex').classList.remove('disabled');
    document.getElementById('latex-button').innerHTML = 'Latex selection';
  }

  if (msg.latexState == 'delatex')  //a text object is selected
  { 
    document.getElementById('matematyk-latex').classList.remove('disabled');
    document.getElementById('latex-button').innerHTML = 'Delatex selection';
  }
  
   if (msg.active) {
     document.getElementById('matematyk').style.display = '';
     document.getElementById('matematyk-checkbox').checked = true;
   }
   else
   {
     document.getElementById('matematyk').style.display = 'none';
     document.getElementById('matematyk-checkbox').checked = false;
   }

  if (!msg.selChange) {
      document.getElementById('matematyk-words').innerHTML = '';
  for (let word of msg.words) {
      const button = document.createElement('div');
      button.classList.add('word-button');
      button.innerHTML = word;
      button.addEventListener('click', e => matematykSendWord(e.target.innerHTML));
      document.getElementById('matematyk-words').prepend(button);
  }
  }
}


// handle messages coming from figma
function messageHandler(event) {
  msg = event.data.pluginMessage;

  //reload the window when the slide changes
  if (msg.type == 'init') {
    changeSlide(msg);
  }

  if (msg.type == 'matematyk') {
    matematyk(msg);
  }

  if (msg.type === 'fetchlatex') {
    fetchLatex(msg.url);
  }


  //get the list of events for the current slide
  if (msg.type == 'eventList') {
    eventList(msg);
  }

  //get the dropdown contents
  if (msg.type == 'dropDownContents') {
    dropDownContents(msg);
  }

  //sends the svg's to the server. Aparently this cannot be done on the plugin side, since it requires internet connectivity.
  if (msg.type == 'savePresentation') {
    savePresentation(msg);
	}
	
	//the selection has been updated. This is used to disable or not items in the toolbar that make sense only if there is a selection
  if (msg.type == 'selChange') {
    selChange(msg);
	}
	
}

// 
onmessage = messageHandler;
postMessage({
  type: 'init'
});



</script>
